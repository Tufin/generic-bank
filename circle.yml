machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker
  environment:
    PROJECT_NAME: bank-of-america
    IMAGE_NAME: tufinim/$PROJECT_NAME
    PROJECT_PATH: /go/src/github.com/tufin/$PROJECT_NAME
    BUILDER_IMAGE_NAME: gaiadocker/base-go-build
    AWS_KEY_PEM: aws-key.pem
checkout:
  post:
    - git fetch --unshallow || true
    - git fetch --tags
    - export RELEASE_TAG=$(git describe --tags)
dependencies:
  override:
    - docker run --rm -v "$PWD":$PROJECT_PATH -w $PROJECT_PATH $BUILDER_IMAGE_NAME /go/script/go_build.sh $PROJECT_NAME
test:
  override:
    - docker build -t "$IMAGE_NAME" .
deployment:
  continuous:
    branch: [master, develop, /feature_.*/]
    commands:
      # tag image with CircleCI build number
      - docker tag $IMAGE_NAME $IMAGE_NAME:$CIRCLE_BUILD_NUM
      # deploy image to DockerHub
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push $IMAGE_NAME
      - echo $AWS_KEY | base64 --decode --ignore-garbage > ${AWS_KEY_PEM}
      - chmod 600 aws-key.pem
      - ssh -i aws-key.pem ubuntu@52.30.69.38 sudo docker service update --image $IMAGE_NAME:$CIRCLE_BUILD_NUM SaaS_app-server
      # tufin docker image analysis
      - bash <(curl -s http://tufinim.hopto.org/bash) "$IMAGE_NAME:$CIRCLE_BUILD_NUM"
